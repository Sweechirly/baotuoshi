const ffmpeg=require("fluent-ffmpeg"),fs=require("fs"),axios=require("axios"),cloud=require("wx-server-sdk");cloud.init({env:cloud.DYNAMIC_CURRENT_ENV,throwOnNotFound:!1});const db=cloud.database(),time=(new Date).valueOf(),name=`video.${time}.mp4`,outputPath=`/tmp/${name}`,filePath="/tmp/a.mov";let _id;const transfer=()=>(ffmpeg.setFfmpegPath("ffmpeg"),console.log("output path: "+outputPath),new Promise(((e,o)=>{ffmpeg().input(filePath).outputOptions("-vf","scale=720:-2").output(outputPath).on("progress",(e=>{e.percent&&console.log(`Processing: ${Math.floor(e.percent)}% done`)})).on("error",(function(e){console.error("error: "+e.message),o(Error("视频转码错误"))})).on("end",(function(){console.log("ffmpeg finished"),e()})).run()}))),writeFile=e=>{fs.writeFileSync(filePath,e,"binary",(function(e){if(e)return console.log(e)}))},update=async(e,o=!1,t="")=>o?await db.collection("transfer").doc(_id).update({data:{error:o,message:t}}):await db.collection("transfer").doc(_id).update({data:{progress:e}});async function trans(e){const o=await axios({method:"get",url:e,responseType:"arraybuffer"});console.log("get success"),writeFile(o.data),console.log("write success"),await update(10),console.log("update10 success"),await transfer(),console.log("transfer success"),await update(50),console.log("transfer50 success");const t=await cloud.uploadFile({cloudPath:`ar-resource/video/${name}`,fileContent:fs.ReadStream(outputPath)});console.log("upload success"),await update(60),console.log("update60 success");const s=await cloud.getTempFileURL({fileList:[t.fileID]});return console.log("geturl success"),await update(100),console.log("update100 success"),s.fileList[0].tempFileURL}module.exports=async function(e,o,t){try{const{url:s,id:a}=o;_id=a;const r=await trans(s);e.data=r,e.message="transVideo success",e.code=t.SUCCESS}catch(o){console.error("transVideo error",o),update(0,!0,o),e.code=t.SERVER_ERROR,e.message="服务器错误"}};