const cloud=require("wx-server-sdk"),TcbRouter=require("tcb-router"),resConfig=require("./config"),loginHandler=require("./_login_handler"),registerHandler=require("./_register_handler"),updateHandler=require("./_update_handler");cloud.init({env:cloud.DYNAMIC_CURRENT_ENV,throwOnNotFound:!1});const db=cloud.database(),CODE=resConfig.CODE;exports.main=async(e,r)=>{const n=cloud.getWXContext(),a=new TcbRouter({event:e}),{queryParams:t}=e,o=n.OPENID,d=function(e,r){a.router(e,(async(e,a)=>{console.log("user openId: ",o,JSON.stringify(n)),await r(e,db,t,CODE),await a()}),(async e=>{e.body={code:e.code||CODE.SUCCESS,message:e.message,data:e.data}}))};return a.use((async(e,r)=>{e.data={_openid:o},await r()})),d("login",loginHandler),d("register",registerHandler),d("update",updateHandler),a.serve()};