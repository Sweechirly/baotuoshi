module.exports=async function(e,a,t,s){try{const{id:o}=t,c=a.command;console.log("接收礼物00： ",o);const d=await a.runTransaction((async a=>{console.log("接收礼物01： ",o);const t=await a.collection("work_list").where({_id:o}).get(),s=t?.data[0];if(console.log("接收礼物02： ",t),!s||s.deleted)return{success:!1,data:{status:0},message:s?"作品已删除":"作品不存在"};if(s.recipientId){const a=s.recipientId===e.data._openid;return{success:!1,data:{status:a?1:2,work:a?s:null},message:a?"不可重复领取":"礼物已被人领走"}}if(s._openid===e.data._openid)return{success:!1,data:{work:s,status:3},message:"不可领取自己的礼物"};const d=await a.collection("work_list").doc(o).update({data:{recipientId:e.data._openid}}),n=await a.collection("user_list").where({_openid:e.data._openid}).update({data:{receivedWorks:c.push(o)}});if(d.stats?.updated&&n.stats?.updated)return s.recipientId=e.data._openid,{success:!0,data:{work:s},message:"礼物领取成功"};await a.rollback(-100)}));console.log("接受作品结果： ",d),e.code=d.success?s.SUCESS:s.FAILE,e.data=d.data,e.message=d.message}catch(a){e.code=s.SERVER_ERROR,e.message="服务器出错"}};